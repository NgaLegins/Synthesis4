<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scream Reaction - Tuned</title>
  <script src="https://unpkg.com/hydra-synth"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: 'Courier New', Courier, monospace;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    
    #content-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: none; 
    }

    #scream-text {
      color: white;
      font-size: 5vw; 
      font-weight: 900; /* Più grassetto per visibilità */
      text-transform: uppercase;
      text-align: center;
      
      /* RIMOSSO mix-blend-mode per evitare che sparisca su sfondo bianco */
      /* AGGIUNTO bordo nero per contrasto massimo */
      text-shadow: 3px 3px 0px #000000; 
      -webkit-text-stroke: 1px black;

      transition: filter 0.1s, transform 0.1s, letter-spacing 0.1s;
      opacity: 0; 
    }

    #start-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      cursor: pointer;
      text-align: center;
    }
    
    #error-log {
        margin-top: 20px;
        color: red;
        font-size: 12px;
        max-width: 80%;
    }
  </style>
</head>
<body>

  <div id="start-overlay">
    <h1>CLICK TO ACTIVATE MIC</h1>
    <p style="color: #666; margin-top: 10px;">(Richiede HTTPS o Localhost)</p>
    <div id="error-log"></div>
  </div>

  <div id="content-layer">
    <h1 id="scream-text">SCREAM TO ACTIVE YOURSELF</h1>
  </div>

  <script>
    const hydra = new Hydra({
      detectAudio: true, 
      enableStreamCapture: false,
    });

    // CONFIGURAZIONE SENSIBILITÀ
    const THRESHOLD = 0.15; // Soglia minima: sotto questo volume, ignora tutto (Noise Gate)
    const SENSITIVITY = 3.0; // Moltiplicatore: più basso è, più devi urlare forte

    let audioVol = 0; // Volume elaborato
    let rawAudio = 0; // Volume grezzo

    // Funzione Tensione per Hydra
    let tension = () => audioVol * SENSITIVITY; 

    // --- HYDRA VISUALS ---
    osc(
      () => 20 + (tension() * 80), 
      () => 0.05 + (tension() * 0.2), 
      () => 0.5 + (tension() * 5)
    )
    .rotate(
      () => time * 0.1, 
      () => 0.1 + (tension() * 0.5) 
    )
    .kaleid(() => 2 + (tension() * 5)) 
    .modulate(
      noise(() => 2 + (tension() * 10), 0.1),
      () => (tension() * 2) 
    )
    // Inversione colori (attiva solo con urla forti)
    .invert(() => (audioVol > 0.5) ? 1 : 0)
    .contrast(() => 1.2 + tension()) // Contrasto base aumentato leggermente
    .brightness(() => 0.4 - (tension() * 0.1)) // Sfondo leggermente più scuro per far risaltare il testo
    
    // PIXELATION
    .pixelate(
      () => {
        // Meno sensibile: l'effetto pixel parte più lentamente
        let val = 3000 / (1 + (tension() * 100));
        return val < 15 ? 15 : val; 
      },
      () => {
        let val = 3000 / (1 + (tension() * 100));
        return val < 15 ? 15 : val;
      }
    )
    .blend(o0, () => 0.1 + (tension() * 0.8)) 
    .out(o0);
    // --------------------

    const overlay = document.getElementById('start-overlay');
    const screamText = document.getElementById('scream-text');
    const errorLog = document.getElementById('error-log');

    overlay.addEventListener('click', function() {
      try {
        a.show(); 
        a.setBins(6); // Usa 6 bin per isolare meglio le frequenze
        
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
          .then((stream) => {
             console.log("Microfono attivo");
             startAnimation();
          })
          .catch((err) => {
             console.error(err);
             errorLog.innerHTML = "ERRORE MICROFONO: " + err.message;
          });

      } catch (e) {
        errorLog.innerText = "Errore Hydra: " + e;
      }
    });

    function startAnimation() {
      overlay.style.opacity = 0;
      setTimeout(() => {
        overlay.style.display = 'none';
        screamText.style.opacity = 1;
        updateTextLoop(); 
      }, 500);
    }

    function updateTextLoop() {
      if (typeof a !== 'undefined' && a.fft) {
        // Prendi il valore grezzo (frequenze basse/voce)
        let currentRaw = a.fft[0]; 

        // NOISE GATE: Se il volume è basso (respiro, rumore fondo), consideralo zero
        if (currentRaw < THRESHOLD) {
            currentRaw = 0;
        } else {
            // Rimuovi l'offset della soglia per rendere la transizione fluida
            currentRaw = (currentRaw - THRESHOLD) * 2; 
        }

        // Smoothing (rende l'animazione meno scattosa)
        audioVol = audioVol * 0.9 + currentRaw * 0.1;
      }

      // Intensità effetto visivo testo
      let intensity = audioVol * 3; 
      if(intensity > 1) intensity = 1;

      // Blur ridotto drasticamente per leggibilità (Max 6px invece di 20px)
      const blurPx = intensity * 6; 
      // Spaziatura lettere ridotta leggermente
      const letterSp = intensity * 30; 
      
      screamText.style.filter = `blur(${blurPx}px)`;
      screamText.style.letterSpacing = `${letterSp}px`;
      
      // Tremolio leggero
      const shakeX = (Math.random() - 0.5) * intensity * 10;
      const shakeY = (Math.random() - 0.5) * intensity * 10;
      
      // Scale leggermente aumentato
      const scaleVal = 1 + (intensity * 0.3);

      screamText.style.transform = `translate(${shakeX}px, ${shakeY}px) scale(${scaleVal})`;

      requestAnimationFrame(updateTextLoop);
    }
  </script>
</body>
</html>
